<!DOCTYPE html>
<html>
  <head>
    <title>In Browser Tiny Tina Wonderland's Save Editor</title>
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://abramhindle.github.io/ttwl-cli-saveedit/" />
    <meta property="og:title" content="In Browser Tiny Tina Wonderland's Save Editor, duplicate save files, fake TVHM, import items" />
    <meta name="google-site-verification" content="ZA9MJWLGd8uurbI8EZT-Bc7ngYjOre39-m40xCIg5ro" />
    <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
    <style>
      .disabled {
          pointer-events: none;
          opacity: 0.4;
      }
      #status {
          background-color: yellow;
      }
      p, ul, ol {
          margin: 1em;
          min-width: 10em;
          width: 50vh;
          padding: 0.25em;
      }
      h1, h2, h3 {
          padding: 0.25em ;
      }
      .smaller {
          font-size: x-small;
      }
      input.numberOption {
          width: 9em;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>Online In Browser Tiny Tina Wonderland's Save Editor</h1>
      <p>
        Do you want to modify Tiny Tina Wonderland's Saves, Tiny Tina
        Wonderland's Savefiles, or Tiny Tina Wonderland's Save Games?
        This is tech demo about running Python code in the browser,
        but you may use it to the modify the savefiles in Tiny Tina's
        Wonderlands. This was working as of TTWL v1.0.4.0a (2022-06-23).
      </p>
      <p>
        Using <a href="https://pyodide.org/en/stable/">Pyodide</a> I managed to host the python commandline program <a href="https://github.com/abramhindle/ttwl-cli-saveedit/">ttwl-cli-saveedit</a> on the web! So this means python is running in your browser. If you want to run it at home just run on a Linux or OSX computer:
        <code>
          <pre>
            pip3 install --user git+https://github.com/abramhindle/ttwl-cli-saveedit
          </pre>
        </code>
      <p>
        More documentation for the commandline program is here: <a href="https://github.com/abramhindle/ttwl-cli-saveedit/">ttwl-cli-saveedit</a>
      </p>
      </p>
      <h3>ttwl-cli-saveedit in your browser</h3>
      <p>
        This webpage provides a user interface for you to modify your Tiny Tina's Wonderlands (TTWL) save files.
        What can this save editor do?
      </p>
      <ul>
        <li> Allow you to duplicate your savefile (change/randomize your GUID). The game cannot see multiple savefiles if they have the same GUID.
        <li> Unfinish all your missions. Do you want to play the game again as your current character? Then click `Unfinish Your Missions` and play the whole game again.
        <li> Do you want the BL3 TVHM experience in TTWL? Well use
        fake TVHM with Chaos Level. Replay the whole story (minus the
        last boss) at your Chaos level and current level. Want to
        primordial mission rewards? I'm not sure that's possible but
          why don't you try it.
        <li> Or do you want to import items from another savefile? Get their balance code and paste them into the item import box and give it a go!
      </ul>
      <h3>Instructions:</h3>
      <ol>
        <li> First load the example file or "upload" your save file. This program will not send your savefiles anywhere, they will be locally manipulated in your browser. The details of the file will be printed below.
        <li> Second, manipulate your savefile. Every button will send you a new savefile that you can download.
        <li> Copy your savefile into your TTWL save game directory or folder and rename to a number dot sav (like "100.sav" or "111.sav").
      </ol>
      <h3>No support provided:</h3>
      <p class="smaller">
        Here's where I come off as a jerk:
        I will listen to actual coherent
        bug
        reports <a href="https://github.com/abramhindle/ttwl-cli-saveedit/issues">here</a>. I am not very interested in feature requests. This is a technology demo.
        I will gladly accept pull requests. If you want something, then make it better, it is opensource, I just wanted to deploy python in the browser. Don't contact me about windows issues, or mac issues, or ask me where savefiles are stored. I don't know these things and I don't have any answers.
      </p>
    </div>
    <div id="status">Loading</div>
    <div id="ui">
      <button id="example" onclick="loadExample()">Load Example</button> or upload your own:
      <input name="upload" id="upload" type="file"><br>
      <div>
      <pre class="needFile">
optional arguments:
  -h, --help            show this help message and exit
  -V, --version         show program's version number and exit
  -o {savegame,protobuf,json,items}, --output {savegame,protobuf,json,items}
                        Output file format (default: savegame)
<span class="textOption" id="--csv"></span>  --csv                 When importing or exporting items, use CSV files
                        (default: False)
  -f, --force           Force output file to overwrite (default: False)
  -q, --quiet           Supress all non-essential output (default: False)
<span class="textOption" id="--name"></span>  --name NAME           Set the name of the character (default: None)
<span class="textOption" id="--save-game-id"></span>  --save-game-id SAVE_GAME_ID
                        Set the save game slot ID (possibly not actually ever
                        needed) (default: None)
<span class="flag" id="--dont-randomize-guid"></span>  --dont-randomize-guid
                        DON'T Randomize the savegame GUID (default: True)
<span class="numberOption" id="--level"></span>  --level LEVEL         Set the character to this level (from 1 to 40)
                        (default: None)
<span class="flag" id="--level-max"></span>  --level-max           Set the character to max level (40) (default: False)
<span class="flag" id="--xp-max"></span>  --xp-max              When using --level, instead of assigning the minimum
                        amount of XP for the level, assign the maximum (so
                        that 1 more XP will level to the next). Has no effect
                        when setting a char to max level. (default: False)
<span class="flag" id="--items-to-char"></span>   --items-to-char       Set all inventory items to the level of the character
                        (default: False)
<span class="numberOption" id="--item-levels"></span>  --item-levels ITEM_LEVELS
                        Set all inventory items to the specified level
                        (default: None)
<span class="flag" id="--items-regular"></span>  --items-regular       Set all inventory item chaos levels to Regular
                        (default: None)
<span class="flag" id="--items-chaotic"></span>  --items-chaotic       Set all inventory item chaos levels to Chaotic
                        (default: None)
<span class="flag" id="--items-volatile"></span>  --items-volatile      Set all inventory item chaos levels to Volatile
                        (default: None)
<span class="flag" id="--items-primordial"></span>  --items-primordial    Set all inventory item chaos levels to Primordial
                        (default: None)
<span class="flag" id="--items-ascended"></span>  --items-ascended      Set all inventory item chaos levels to Ascended
                        (default: None)
<span class="flag" id="--clear-rerolls"></span>  --clear-rerolls       Clears the reroll counter for all items in inventory
                        (default: False)
<span class="textOption" id="--backstory"></span>  --backstory {idiot,elves,monk,hoarder,alchemist}
                        Set backstory (default: None)
<span class="numberOption" id="--hero-stats"></span>  --hero-stats HERO_STATS
                        Sets all raw Hero Stats to the specified value (from
                        10-30) (default: None)
<span class="flag" id="--hero-stats-max"></span>  --hero-stats-max      Sets all raw Hero Stats to their maximum values
                        (default: False)
<span class="numberOption" id="--str"></span>  --str STRENGTH        Sets the value of the Strength Hero Stat (from 10-30)
                        (default: None)
<span class="numberOption" id="--dex"></span>  --dex DEXTERITY       Sets the value of the Dexterity Hero Stat (from 10-30)
                        (default: None)
<span class="numberOption" id="--int"></span>  --int INTELLIGENCE    Sets the value of the Intelligence Hero Stat (from
                        10-30) (default: None)
<span class="numberOption" id="--wis"></span>  --wis WISDOM          Sets the value of the Wisdom Hero Stat (from 10-30)
                        (default: None)
<span class="numberOption" id="--con"></span>  --con CONSTITUTION    Sets the value of the Constitution Hero Stat (from
                        10-30) (default: None)
<span class="numberOption" id="--att"></span>  --att ATTUNEMENT      Sets the value of the Attunement Hero Stat (from
                        10-30) (default: None)
<span class="numberOption" id="--chaos"></span>  --chaos CHAOS         Set the Chaos Level (default: None)
<span class="numberOption" id="--money"></span>  --money MONEY         Set money value (default: None)
<span class="numberOption" id="--moon-orbs"></span>  --moon-orbs MOON_ORBS
                        Set Moon Orbs value (default: None)
<span class="numberOption" id="--souls"></span>  --souls SOULS         Set Lost Souls value (default: None)
<span class="textOption" id="--unlock"></span>  --unlock {ammo,backpack,equipslots,feat,multiclass,all}
                        Game features to unlock (default: {})
<span class="flag" id="--unfinish-missions"></span>  --unfinish-missions   "Un-finishes" the game: remove all Playthrough 0 to
                        Not Completed (default: False)
<span class="flag" id="--fake-tvhm"></span>   --fake-tvhm           "Un-finishes" the missions but finishes the game
                        (default: False)
<span class="textFile" id="-i" filename="/import.txt"></span>  -i IMPORT_ITEMS, --import-items IMPORT_ITEMS
                        Import items from file (default: None)
<span class="textOption" id="--delete-mission"></span>  --delete-mission MISSIONPATH
                        Deletes all stored info about the specified mission.
                        Will only work on sidemissions. Use ttwl-save-info's
                        --mission-paths to see the correct mission path to use
                        here. This option can be specified more than once.
                        (default: None)
  --randomize-customizations PROFILE
                        Randomize customziations based on the customizations
                        unlocked in the specified profile file. (default:
                        None)
  --overdrive           When randomizing customizations, use the "overdrive"
                        slider settings, which allow for wilder extremes.
                        (default: False)

      </pre>
      <button id="run" onclick="runTTWLSaveEdit()">Run ttwl-save-edit and download modified savefile</button>
    </div>
    <div>
          <code>
            <pre id="output">
            </pre>
          </code>
      <h2> Character Info <h2>
          <code>
            <pre id="cinfo">
            </pre>
          </code>
    </div>
    <script type="text/javascript">
      var pkg = undefined;
      var content = undefined;
      var uiElements = ["upload","example","downloadInput","dupeFile"]
      function disableUI(v) {
          v = v?true:false;
          [...(document.getElementById("ui").children)].forEach( elm => {
              if (v) {
                  elm.classList.add("disabled");
              } else {
                  elm.classList.remove("disabled");
              }
          });
          // uiElements.forEach( id => document.getElementById(id).disabled = value );
      }
      function disableNeedFile(v) {
          v = v?true:false;
          [...(document.getElementsByClassName("needFile"))].forEach( elm => {
              if (v) {
                  elm.classList.add("disabled");
              } else {
                  elm.classList.remove("disabled");
              }
          });
      }
      function status(x) {
          document.getElementById("status").innerText = x;
      }
      function installListeners() {
          document.getElementById("upload").onchange = function(e) {
              const file = e.target.files[0];
              console.log(file);
              loadFile(file);
          }
      }
      function characterInfo() {
          document.getElementById("cinfo").innerText = pkg.character_info();
      }
      function logOutput(text) {
          document.getElementById("output").innerText = text;
      }
      function loadExample() {
          if (pkg === undefined) {
              status("File not loaded yet");
              return;
          }
          status("Loading Example!");
          pkg.load_example().then( res => {
              status("TTWLSave loaded: " + res);
              characterInfo();
              disableNeedFile(false);
          });
      }
      function loadFile(file) {
          // josephernest https://github.com/pyodide/pyodide/issues/679#issuecomment-637519913
          var reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onload = evt => { 
              content = evt.target.result; 
              status("Bytes written: "+pkg.load_file_from_browser());
              characterInfo();
              disableNeedFile(false);
          }          
      }
      function downloadInputFile(filename) {
          var array = pkg.get_input_file();
          downloadArray(array,filename);
      }
      function downloadOutputFile() {
          var array = pkg.get_output_file();
          var filename = "ttwl-"+pkg.get_guid()+".sav";
          downloadArray(array,filename);
      }
      function downloadArray(array,filename) {
          var blob = new Blob([array], {type: 'application/octet-stream'});
          var url = window.URL.createObjectURL(blob);
          // This part is dumb, why javascript do I have to do this?
          var anchor = window.document.createElement('a');
          anchor.href = url;
          anchor.download = filename?filename:"output.sav";
          document.body.appendChild(anchor);
          anchor.click();
          document.body.removeChild(anchor);          
      }
      function randomizeGUID() {
          disableUI(true);          
          status("Randomizing the GUID");
          var newGUID = pkg.randomize_guid();
          status("New GUID: "+newGUID);
          characterInfo();
          // downloadOutputFile();
          downloadInputFile("ttwl-"+newGUID+".sav");
          disableUI(false);
      }

      function isOptionEnabled( domObj ) {
          var elm = domObj.querySelector('.optionEnable');
          return elm.checked;
      }
      function getValueOfOption( domObj ) {
          if (domObj.classList.contains('textFile')) {
              return domObj.getAttribute('filename');
          }
          var v = domObj.querySelector('input.numberOption, input.textOption');
          return v.value;
      }
      function getTextFileInput( domObj ) {
          if (domObj.classList.contains('textFile') && isOptionEnabled(domObj)) {
              var v = domObj.querySelector('textarea.textFile');
              return v.value;
          }
          return "";
      }
      function commandLineArgs() {
          var flags = [...document.querySelectorAll('span.flag')];
          var checked = flags.filter( isOptionEnabled );
          var checkedOptions = checked.map( x => [x.id] ).flat();
          // console.log(["CheckOptions",checkedOptions]);
          var values = [...document.querySelectorAll('span.numberOption, span.textOption, span.textFile')];
          // console.log(["Values",values]);
          var valued = values.filter( isOptionEnabled );
          // console.log(["Valued",valued]);
          var valuedOptions = valued.map( x => [x.id, getValueOfOption(x) ] ).flat();
          // console.log(valuedOptions);
          return checkedOptions.concat( valuedOptions );
      }
      function computeCommandline() {
          var args = commandLineArgs();
          var text = args.join(" ");          
          console.log(text);
          status("ttwl-save-edit -f "+text+ " input.sav input.sav");
      }
      function makeCheckBox(option) {
          var input = document.createElement("input");
          input.type = "checkbox";
          input.setAttribute('class', "optionEnable");
          input.setAttribute('option', option);
          input.onchange = computeCommandline;
          return input;
      }
      function makeTextInput(option) {
          var input = document.createElement("input");
          input.type = "text";
          input.setAttribute('class', "textOption");
          input.setAttribute('option', option);
          input.onchange = computeCommandline;
          return input;
      }
      function makeNumberInput(option) {
          var input = makeTextInput(option);
          input.setAttribute('class',"numberOption");
          // input.setAttribute('size',9);
          return input;
      }
      function makeTextFileInput(option,filename) {
          var input = document.createElement("textarea");
          input.setAttribute('class', "textFile");
          input.setAttribute('cols', 80);
          input.setAttribute('option', option);
          input.setAttribute('filename', filename);
          input.onchange = computeCommandline;
          return input;
      }

      function decorateText( textOption ) {
          var input = makeCheckBox(textOption.id);
          textOption.appendChild( input );
          textOption.appendChild(makeTextInput(textOption.id));
      }
      function decorateFlag( textOption ) {
          var input = makeCheckBox(textOption.id);
          textOption.appendChild( input );
      }
      function decorateNumber( numberOption ) {
          var input = makeCheckBox(numberOption.id);
          numberOption.appendChild( input );          
          numberOption.appendChild(makeNumberInput(numberOption.id));          
      }
      function decorateTextFile( textFileOption ) {
          var input = makeCheckBox(textFileOption.id);
          textFileOption.appendChild( input );          
          textFileOption.appendChild(makeTextFileInput(textFileOption.id,textFileOption.getAttribute('filename')));          
      }
      function decorateUI() {
          let decor = ( query, decorator) => [...(document.querySelectorAll(query))].forEach( to => decorator( to ) );
          decor('span.textOption', decorateText);
          decor('span.flag', decorateFlag);
          decor('span.numberOption', decorateNumber);
          decor('span.textFile', decorateTextFile);
      }

      function runTTWLSaveEdit() {
          disableUI(true);          
          var dashI = document.getElementById('-i');
          var importDotTxt = getTextFileInput(dashI);
          if (importDotTxt && importDotTxt.length > 0) {
              status("Writing Out Imports");
              pkg.write_text('/import.txt', importDotTxt);
          }
          // var newGUID = pkg.randomize_guid();
          var args = commandLineArgs();
          args = ["-f"].concat(args);
          var output = pkg.save_edit_command_line(args);
          logOutput(output);
          characterInfo();
          downloadInputFile("ttwl-"+pkg.get_guid()+".sav");
          disableUI(false);          
      }
      
      async function main(){
          let pyodide = await loadPyodide();
          await pyodide.loadPackage(["micropip"]);
          console.log(pyodide.runPython("\" \".join([\"Hello\",\"World\"])"));
          await pyodide.runPythonAsync(`
    from pyodide.http import pyfetch
    response = await pyfetch("./script.py")
    with open("script.py", "wb") as f:
        f.write(await response.bytes())
`
                                      )          
          status("Loading python");
          pkg = pyodide.pyimport("script");
          status("Installing Python modules");
          await pkg.install_deps();
          status("Python Modules Installed: READY TO GO!");
          disableUI(false);
      }
      disableUI(true);
      window.addEventListener("load", 
                              function() {
                                  decorateUI();
                                  //return;
                                  disableUI(true);
                                  installListeners();
                                  main().then( () => {
                                      disableUI(false);
                                      disableNeedFile(true);
                                  })
                              }, false);
                              
    </script>
  </body>
</html>
